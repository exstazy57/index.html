<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DAG Mines - Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; padding: 0; overflow: hidden; }
        
        /* –•–µ–¥–µ—Ä —Å –±–∞–ª–∞–Ω—Å–æ–º */
        .header { background: #222; padding: 15px; border-bottom: 2px solid #f7941d; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        .balance-box { color: #f7941d; font-weight: bold; font-size: 18px; text-shadow: 0 0 10px rgba(247, 148, 29, 0.3); }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; max-width: 320px; margin: 20px auto; display: none; }
        .cell { width: 55px; height: 55px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; border: 2px solid #444; transition: 0.2s; }
        .cell.open.gem { background: #2ecc71; border-color: #27ae60; box-shadow: 0 0 10px #2ecc71; }
        .cell.open.bomb { background: #e74c3c; border-color: #c0392b; animation: shake 0.2s; }
        
        @keyframes shake { 0% {transform:translateX(0)} 25% {transform:translateX(5px)} 50% {transform:translateX(-5px)} 100% {transform:translateX(0)} }

        .menu { background: #222; padding: 20px; border-radius: 15px; border: 1px solid #444; margin: 20px; }
        select, input { width: 90%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; border-radius: 8px; font-size: 16px; text-align: center; }
        
        button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-start { background: #f7941d; color: white; }
        .btn-cashout { background: #2ecc71; color: white; display: none; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); }
        .btn-exit { background: #444; color: #ccc; font-size: 12px; padding: 8px; margin-top: 20px; width: auto; display: inline-block; padding: 10px 30px; }
        
        #info { margin-bottom: 15px; font-size: 18px; color: #f7941d; font-weight: bold; }
        .label { font-size: 14px; color: #aaa; margin-top: 10px; display: block; }
    </style>
</head>
<body>

    <div class="header">
        <span>DAG MINES</span>
        <div class="balance-box">‚≠ê <span id="balance-val">0</span></div>
    </div>

    <div id="setup-area" class="menu">
        <span class="label">–°–£–ú–ú–ê –°–¢–ê–í–ö–ò (‚≠ê)</span>
        <input type="number" id="bet-input" value="10" min="1">
        
        <span class="label">–£–†–û–í–ï–ù–¨ –°–õ–û–ñ–ù–û–°–¢–ò</span>
        <select id="difficulty">
            <option value="3">–õ–µ–≥–∫–æ (3 –º–∏–Ω—ã) - x1.12</option>
            <option value="5" selected>–°—Ä–µ–¥–Ω–µ (5 –º–∏–Ω) - x1.23</option>
            <option value="10">–°–ª–æ–∂–Ω–æ (10 –º–∏–Ω) - x1.65</option>
            <option value="15">–≠–∫—Å—Ç—Ä–∏–º (15 –º–∏–Ω) - x2.40</option>
        </select>
        
        <button class="btn-start" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
    </div>

    <div id="game-area">
        <div id="info" style="display:none">–ú–Ω–æ–∂–∏—Ç–µ–ª—å: <span id="mult">x1.00</span></div>
        <div class="grid" id="grid"></div>
        <button id="cashout-btn" class="btn-cashout" onclick="cashOut()">–ó–ê–ë–†–ê–¢–¨ <span id="win-amount">0</span> ‚≠ê</button>
    </div>

    <center>
        <button class="btn-exit" onclick="exitGame()">üíæ –°–û–•–†–ê–ù–ò–¢–¨ –ò –í–´–ô–¢–ò</button>
    </center>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        let currentBalance = parseInt(urlParams.get('bal')) || 0;

        let bet = 0;
        let mineCount = 0;
        let bombs = [];
        let gemsFound = 0;
        let isGameOver = false;
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        const growthRates = { "3": 0.12, "5": 0.23, "10": 0.65, "15": 1.40 };

        function updateBalanceUI() {
            document.getElementById('balance-val').innerText = currentBalance;
        }
        updateBalanceUI();

        // –ó–≤—É–∫–æ–≤–æ–π –¥–≤–∏–∂–æ–∫
        function playSound(freq, type, duration) {
            let osc = audioCtx.createOscillator();
            let gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function startGame() {
            bet = parseInt(document.getElementById('bet-input').value);
            mineCount = parseInt(document.getElementById('difficulty').value);
            
            if (bet > currentBalance) {
                tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–≤–µ–∑–¥!");
                return;
            }
            if (isNaN(bet) || bet <= 0) return;

            // –°–Ω–∏–º–∞–µ–º —Å—Ç–∞–≤–∫—É
            currentBalance -= bet;
            updateBalanceUI();
            playSound(440, 'sine', 0.1);

            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('grid').style.display = 'grid';
            document.getElementById('info').style.display = 'block';
            initGrid();
        }

        function initGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            bombs = [];
            gemsFound = 0;
            isGameOver = false;
            document.getElementById('mult').innerText = "x1.00";
            document.getElementById('cashout-btn').style.display = 'none';

            while(bombs.length < mineCount) {
                let randomPos = Math.floor(Math.random() * 25);
                if(!bombs.includes(randomPos)) bombs.push(randomPos);
            }

            for(let i=0; i<25; i++) {
                let cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => openCell(i, cell);
                grid.appendChild(cell);
            }
        }

        function openCell(idx, el) {
            if(isGameOver || el.classList.contains('open')) return;
            el.classList.add('open');

            if(bombs.includes(idx)) {
                el.classList.add('bomb');
                el.innerText = 'üí•';
                playSound(100, 'sawtooth', 0.4);
                endGame(false);
            } else {
                el.classList.add('gem');
                el.innerText = 'üíé';
                gemsFound++;
                playSound(600 + (gemsFound * 100), 'sine', 0.2);
                tg.HapticFeedback.impactOccurred('light');
                updateGameUI();
            }
        }

        function updateGameUI() {
            let rate = growthRates[mineCount.toString()];
            let multiplier = (1 + (gemsFound * rate)).toFixed(2);
            let currentWin = Math.floor(bet * multiplier);
            
            document.getElementById('mult').innerText = "x" + multiplier;
            document.getElementById('win-amount').innerText = currentWin;
            document.getElementById('cashout-btn').style.display = 'block';
        }

        function cashOut() {
            if(isGameOver || gemsFound === 0) return;
            let win = parseInt(document.getElementById('win-amount').innerText);
            currentBalance += win;
            updateBalanceUI();
            playSound(800, 'sine', 0.3);
            tg.showAlert("–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ " + win + " ‚≠ê");
            resetToMenu();
        }

        function endGame(isWin) {
            isGameOver = true;
            if(!isWin) {
                tg.HapticFeedback.notificationOccurred('error');
                bombs.forEach(pos => {
                    let c = document.getElementById('grid').children[pos];
                    c.classList.add('bomb');
                    c.innerText = 'üí£';
                });
                setTimeout(() => {
                    resetToMenu();
                }, 2000);
            }
        }

        function resetToMenu() {
            document.getElementById('setup-area').style.display = 'block';
            document.getElementById('grid').style.display = 'none';
            document.getElementById('info').style.display = 'none';
            document.getElementById('cashout-btn').style.display = 'none';
        }

        function exitGame() {
            // –¢–æ–ª—å–∫–æ –∑–¥–µ—Å—å –º—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            tg.sendData(JSON.stringify({
                action: "sync_balance", 
                final_balance: currentBalance
            }));
        }
    </script>
</body>
</html>
