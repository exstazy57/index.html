<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DAG PLINKO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #0a0e14; font-family: 'Orbitron', sans-serif; color: white; touch-action: none; }
        canvas { display: block; }
        
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 15px; box-sizing: border-box; }
        #header { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .badge { background: rgba(20, 25, 35, 0.9); border: 1px solid #00f2ff; padding: 8px 15px; border-radius: 12px; color: #00f2ff; font-weight: 900; }
        
        #controls { background: #151a21; padding: 20px; border-radius: 20px; pointer-events: auto; border-top: 2px solid #2a303c; }
        .bet-box { display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: 0 auto; }
        
        input { background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; font-size: 18px; text-align: center; font-family: 'Orbitron'; outline: none; }
        button { padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 900; border: none; font-family: 'Orbitron'; cursor: pointer; text-transform: uppercase; }
        #btn-play { background: linear-gradient(180deg, #00f2ff, #0077ff); color: #000; box-shadow: 0 0 15px rgba(0, 242, 255, 0.4); }
        button:active { transform: scale(0.96); }
        
        .btn-exit { background: none; color: #555; font-size: 10px; margin-top: 10px; border: none; text-decoration: underline; pointer-events: auto; }
    </style>
</head>
<body>

    <canvas id="plinkoCanvas"></canvas>

    <div id="ui">
        <div id="header">
            <div class="badge">⭐ <span id="bal-display">0</span></div>
            <button onclick="finalizeAndExit()" style="background:rgba(255,255,255,0.1); color:#fff; padding:5px 10px; border-radius:8px; font-size:10px; border:none; pointer-events:auto;">ВЫХОД</button>
        </div>

        <div id="controls">
            <div class="bet-box">
                <input type="number" id="bet-input" value="10" min="10">
                <button id="btn-play" onclick="dropBall()">DROP BALL</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        let balance = parseInt(urlParams.get('bal')) || 0;
        document.getElementById('bal-display').innerText = balance;

        const canvas = document.getElementById('plinkoCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Настройки Plinko
        const rows = 8;
        const pins = [];
        const balls = [];
        const buckets = [
            {m: 5, c: "#ff3e3e"}, {m: 2, c: "#ff8800"}, {m: 0.5, c: "#ffff00"}, {m: 0.2, c: "#00ff88"},
            {m: 0.2, c: "#00ff88"}, {m: 0.5, c: "#ffff00"}, {m: 2, c: "#ff8800"}, {m: 5, c: "#ff3e3e"}
        ];

        // Звуки
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(f, d, v=0.1) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.frequency.value = f; g.gain.value = v;
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + d);
        }

        // Генерация колышков (пирамида)
        const spacing = canvas.width / (rows + 2);
        const startY = 120;
        for (let i = 2; i <= rows + 1; i++) {
            const rowY = startY + (i - 2) * spacing;
            for (let j = 0; j < i; j++) {
                pins.push({
                    x: canvas.width / 2 - (i - 1) * spacing / 2 + j * spacing,
                    y: rowY
                });
            }
        }

        function dropBall() {
            const bet = parseInt(document.getElementById('bet-input').value);
            if (bet > balance || bet < 10) return;
            
            balance -= bet;
            document.getElementById('bal-display').innerText = balance;
            
            if(audioCtx.state === 'suspended') audioCtx.resume();

            balls.push({
                x: canvas.width / 2 + (Math.random() - 0.5) * 10,
                y: 50,
                vx: 0,
                vy: 0,
                radius: 6,
                bet: bet
            });
            playSfx(400, 0.1, 0.05);
        }

        function update() {
            ctx.fillStyle = "#0a0e14";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Отрисовка колышков
            ctx.fillStyle = "#2a303c";
            pins.forEach(p => {
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill();
            });

            // Отрисовка лунок (корзин)
            const bW = canvas.width / buckets.length;
            const bY = startY + rows * spacing;
            buckets.forEach((b, i) => {
                ctx.fillStyle = b.c;
                ctx.globalAlpha = 0.2;
                ctx.fillRect(i * bW + 2, bY, bW - 4, 40);
                ctx.globalAlpha = 1;
                ctx.fillStyle = "#fff";
                ctx.font = "bold 12px Orbitron";
                ctx.textAlign = "center";
                ctx.fillText("x" + b.m, i * bW + bW/2, bY + 25);
            });

            // Физика шариков
            for (let i = balls.length - 1; i >= 0; i--) {
                let b = balls[i];
                b.vy += 0.2; // Гравитация
                b.x += b.vx;
                b.y += b.vy;
                b.vx *= 0.99; // Трение воздуха

                // Столкновение с колышками
                pins.forEach(p => {
                    const dx = b.x - p.x;
                    const dy = b.y - p.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < b.radius + 3) {
                        const angle = Math.atan2(dy, dx);
                        const force = 1.5;
                        b.vx += Math.cos(angle) * force + (Math.random() - 0.5);
                        b.vy = Math.abs(b.vy) * 0.6; 
                        b.y = p.y + Math.sin(angle) * (b.radius + 3.1);
                        playSfx(200 + Math.random()*100, 0.05, 0.02);
                    }
                });

                // Отрисовка шарика
                ctx.fillStyle = "#00f2ff";
                ctx.shadowBlur = 10; ctx.shadowColor = "#00f2ff";
                ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2); ctx.fill();
                ctx.shadowBlur = 0;

                // Попадание в лунку
                if (b.y > bY) {
                    const bucketIndex = Math.floor(b.x / bW);
                    if (bucketIndex >= 0 && bucketIndex < buckets.length) {
                        const win = Math.floor(b.bet * buckets[bucketIndex].m);
                        balance += win;
                        document.getElementById('bal-display').innerText = balance;
                        playSfx(win > 0 ? 800 : 100, 0.2, 0.1);
                    }
                    balls.splice(i, 1);
                }
            }

            requestAnimationFrame(update);
        }

        function finalizeAndExit() {
            tg.sendData(JSON.stringify({action: "sync_balance", final_balance: balance}));
        }

        update();
    </script>
</body>
</html>