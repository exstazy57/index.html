<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DAG PLINKO PRO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #0a0e14; font-family: 'Orbitron', sans-serif; color: white; touch-action: none; }
        canvas { display: block; }
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 15px; box-sizing: border-box; }
        #header { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .badge { background: rgba(20, 25, 35, 0.9); border: 1px solid #00f2ff; padding: 8px 15px; border-radius: 12px; color: #00f2ff; font-weight: 900; }
        #controls { background: #151a21; padding: 20px; border-radius: 20px; pointer-events: auto; border-top: 2px solid #2a303c; }
        .bet-box { display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: 0 auto; }
        input { background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 10px; font-size: 18px; text-align: center; font-family: 'Orbitron'; outline: none; }
        button { padding: 15px; border-radius: 10px; font-size: 16px; font-weight: 900; border: none; font-family: 'Orbitron'; cursor: pointer; text-transform: uppercase; }
        #btn-play { background: linear-gradient(180deg, #00f2ff, #0077ff); color: #000; box-shadow: 0 0 15px rgba(0, 242, 255, 0.4); }
        button:active { transform: scale(0.96); }
    </style>
</head>
<body>

    <canvas id="plinkoCanvas"></canvas>

    <div id="ui">
        <div id="header">
            <div class="badge">⭐ <span id="bal-display">0</span></div>
            <button onclick="finalizeAndExit()" style="background:rgba(255,255,255,0.1); color:#fff; padding:5px 10px; border-radius:8px; font-size:10px; border:none; pointer-events:auto;">ВЫХОД</button>
        </div>

        <div id="controls">
            <div class="bet-box">
                <input type="number" id="bet-input" value="10" min="10">
                <button id="btn-play" onclick="dropBall()">DROP BALL</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        let balance = parseInt(urlParams.get('bal')) || 0;
        document.getElementById('bal-display').innerText = balance;

        const canvas = document.getElementById('plinkoCanvas');
        const ctx = canvas.getContext('2d');
        
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Настройки пирамиды (увеличили до 12 рядов)
        const rows = 12;
        const pins = [];
        const balls = [];
        
        // Массив множителей (много мелких в центре)
        const buckets = [
            {m: 10, c: "#ff0000"}, {m: 5, c: "#ff4500"}, {m: 2, c: "#ffa500"}, 
            {m: 0.5, c: "#ffff00"}, {m: 0.2, c: "#9acd32"}, {m: 0.2, c: "#00ff00"}, 
            {m: 0.2, c: "#9acd32"}, {m: 0.5, c: "#ffff00"}, {m: 2, c: "#ffa500"}, 
            {m: 5, c: "#ff4500"}, {m: 10, c: "#ff0000"}
        ];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(f, d, v=0.05) {
            try {
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.frequency.value = f; g.gain.value = v;
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime + d);
            } catch(e){}
        }

        // Генерация колышков (пирамида 12 рядов)
        const spacing = canvas.width / (rows + 3);
        const startY = 100;
        for (let i = 2; i <= rows + 1; i++) {
            const rowY = startY + (i - 2) * (spacing * 0.9);
            for (let j = 0; j < i; j++) {
                pins.push({
                    x: canvas.width / 2 - (i - 1) * spacing / 2 + j * spacing,
                    y: rowY
                });
            }
        }

        function dropBall() {
            const bet = parseInt(document.getElementById('bet-input').value);
            if (bet > balance || bet < 10) return;
            
            balance -= bet;
            document.getElementById('bal-display').innerText = balance;
            
            if(audioCtx.state === 'suspended') audioCtx.resume();

            balls.push({
                x: canvas.width / 2 + (Math.random() - 0.5) * 5,
                y: 50, vx: 0, vy: 0, radius: 5, bet: bet
            });
            playSfx(440, 0.05);
        }

        function update() {
            ctx.fillStyle = "#0a0e14";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Колышки
            ctx.fillStyle = "#3a4452";
            pins.forEach(p => {
                ctx.beginPath(); ctx.arc(p.x, p.y, 2.5, 0, Math.PI * 2); ctx.fill();
            });

            // Лунки
            const bW = canvas.width / buckets.length;
            const bY = startY + rows * (spacing * 0.9);
            buckets.forEach((b, i) => {
                ctx.fillStyle = b.c;
                ctx.globalAlpha = 0.15;
                ctx.fillRect(i * bW + 1, bY, bW - 2, 35);
                ctx.globalAlpha = 1;
                ctx.font = "bold 10px Orbitron";
                ctx.textAlign = "center";
                ctx.fillText(b.m, i * bW + bW/2, bY + 22);
            });

            // Шарики
            for (let i = balls.length - 1; i >= 0; i--) {
                let b = balls[i];
                b.vy += 0.25; 
                b.x += b.vx; b.y += b.vy;
                b.vx *= 0.98;

                pins.forEach(p => {
                    const dx = b.x - p.x; const dy = b.y - p.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < b.radius + 2.5) {
                        const angle = Math.atan2(dy, dx);
                        const bounce = 1.4;
                        b.vx += Math.cos(angle) * bounce + (Math.random() - 0.5) * 0.5;
                        b.vy = Math.abs(b.vy) * 0.5;
                        b.y = p.y + Math.sin(angle) * (b.radius + 2.6);
                        playSfx(300 + Math.random()*200, 0.03);
                    }
                });

                ctx.fillStyle = "#00f2ff";
                ctx.beginPath(); ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2); ctx.fill();

                if (b.y > bY) {
                    const idx = Math.floor(b.x / bW);
                    if (idx >= 0 && idx < buckets.length) {
                        const win = Math.floor(b.bet * buckets[idx].m);
                        balance += win;
                        document.getElementById('bal-display').innerText = balance;
                        playSfx(win >= b.bet ? 800 : 150, 0.1);
                    }
                    balls.splice(i, 1);
                }
            }
            requestAnimationFrame(update);
        }

        function finalizeAndExit() {
            tg.sendData(JSON.stringify({action: "sync_balance", final_balance: balance}));
        }
        update();
    </script>
</body>
</html>
