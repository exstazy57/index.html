<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DAG AVIATOR PREMIUM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #05070a; font-family: 'Orbitron', sans-serif; color: white; touch-action: none; }
        canvas { display: block; filter: contrast(1.1); }
        
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; }
        
        #header { display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .badge { background: rgba(10, 15, 25, 0.9); border: 1px solid #00f2ff; padding: 8px 15px; border-radius: 12px; color: #00f2ff; font-weight: 900; box-shadow: 0 0 15px rgba(0,242,255,0.2); }
        
        #multiplier-box { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #multiplier { font-size: 75px; font-weight: 900; color: #fff; text-shadow: 0 0 30px #00f2ff; margin: 0; }
        #status-text { font-size: 12px; color: #00f2ff; letter-spacing: 3px; text-transform: uppercase; margin-top: -10px; }

        #controls { background: #11151c; padding: 20px; border-radius: 25px 25px 15px 15px; pointer-events: auto; border-top: 2px solid #2a2f3a; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
        .bet-box { display: flex; flex-direction: column; gap: 12px; max-width: 400px; margin: 0 auto; }
        
        input { background: #000; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 12px; font-size: 22px; text-align: center; font-family: 'Orbitron'; outline: none; }
        input:focus { border-color: #00f2ff; }
        
        button { padding: 18px; border-radius: 12px; font-size: 18px; font-weight: 900; border: none; font-family: 'Orbitron'; transition: 0.2s; text-transform: uppercase; }
        #btn-bet { background: linear-gradient(180deg, #00ff88, #00a859); color: #002b17; }
        #btn-cash { background: linear-gradient(180deg, #ffcc00, #d4ac00); color: #2b2100; display: none; }
        button:active { transform: scale(0.96); }

        /* Окно после раунда */
        #modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:100; pointer-events:auto; backdrop-filter: blur(8px); }
        #modal-card { background: #1a1f2b; border: 2px solid #00f2ff; padding: 40px; border-radius: 30px; text-align: center; width: 80%; max-width: 320px; }
        .win { color: #00ff88; font-size: 45px; font-weight: 900; }
        .lose { color: #ff3e3e; font-size: 45px; font-weight: 900; }
        .btn-restart { background: #00f2ff; color: #000; width: 100%; margin-top: 25px; cursor: pointer; }
        .btn-exit { background: none; color: #666; font-size: 12px; margin-top: 15px; border: none; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="modal">
        <div id="modal-card">
            <div id="modal-title" style="color:#aaa; font-size:14px;">РЕЗУЛЬТАТ</div>
            <div id="modal-val"></div>
            <button class="btn-restart" onclick="closeModal()">ИГРАТЬ СНОВА</button>
            <button class="btn-exit" onclick="finalizeAndExit()">ВЫЙТИ В БОТА</button>
        </div>
    </div>

    <div id="ui">
        <div id="header">
            <div class="badge">⭐ <span id="bal-display">0</span></div>
            <div style="color:#666; font-size:10px;">DAG AVIATOR v2.0</div>
        </div>
        <div id="multiplier-box">
            <div id="status-text">WAITING FOR BET...</div>
            <div id="multiplier">1.00x</div>
        </div>
        <div id="controls">
            <div class="bet-box">
                <input type="number" id="bet-input" value="10" min="10">
                <button id="btn-bet" onclick="startRound()">PLACE BET</button>
                <button id="btn-cash" onclick="cashOut()">CASHOUT</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const urlParams = new URLSearchParams(window.location.search);
        let balance = parseInt(urlParams.get('bal')) || 0;
        document.getElementById('bal-display').innerText = balance;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let isFlying = false, mult = 1.0, bet = 0, crashAt = 0, startTime = 0;
        let stars = [];
        for(let i=0; i<120; i++) stars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2+1});

        // --- AUDIO ENGINE ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        function playSound(freq, type, dur, vol=0.1) {
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + dur);
            } catch(e) {}
        }

        function drawRocket(x, y, scale=1) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(scale, scale);
            ctx.rotate(-0.15);

            // Flame
            if(isFlying) {
                const fSize = 10 + Math.random()*15;
                const g = ctx.createRadialGradient(-20,0,0, -30,0, fSize*2.5);
                g.addColorStop(0, '#fff'); g.addColorStop(0.2, '#00f2ff'); g.addColorStop(1, 'transparent');
                ctx.fillStyle = g;
                ctx.beginPath(); ctx.ellipse(-25, 0, fSize*3, fSize/1.5, 0, 0, Math.PI*2); ctx.fill();
            }

            // Stabilizers
            ctx.fillStyle = "#444";
            ctx.beginPath(); ctx.moveTo(-10,-15); ctx.lineTo(-22,-22); ctx.lineTo(-22,22); ctx.lineTo(-10,15); ctx.fill();
            
            // Body
            const grad = ctx.createLinearGradient(0, -12, 0, 12);
            grad.addColorStop(0, '#bdc3c7'); grad.addColorStop(0.5, '#ecf0f1'); grad.addColorStop(1, '#95a5a6');
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.moveTo(40, 0);
            ctx.bezierCurveTo(40, -15, -20, -15, -25, -10);
            ctx.lineTo(-25, 10);
            ctx.bezierCurveTo(-20, 15, 40, 15, 40, 0);
            ctx.fill();

            // Nose
            ctx.fillStyle = "#ff3e3e";
            ctx.beginPath(); ctx.moveTo(40,0); ctx.bezierCurveTo(40,-10, 25,-10, 25,0); ctx.bezierCurveTo(25,10, 40,10, 40,0); ctx.fill();

            // Window
            ctx.fillStyle = "#1a1f2b";
            ctx.beginPath(); ctx.arc(8, 0, 6, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#00f2ff";
            ctx.beginPath(); ctx.arc(8, 0, 4, 0, Math.PI*2); ctx.fill();

            ctx.restore();
        }

        function animate() {
            ctx.fillStyle = "#05070a";
            ctx.fillRect(0,0,canvas.width, canvas.height);

            stars.forEach(s => {
                ctx.fillStyle = "#fff";
                s.x -= isFlying ? s.s*15 : s.s;
                if(s.x < 0) s.x = canvas.width;
                ctx.fillRect(s.x, s.y, s.s, s.s);
            });

            if(isFlying) {
                let sec = (Date.now() - startTime)/1000;
                mult = Math.pow(1.075, sec * 2.8);
                
                if(mult >= crashAt) return endRound(false);
                
                document.getElementById('multiplier').innerText = mult.toFixed(2) + "x";
                let shake = Math.sin(Date.now()*0.05)*3;
                drawRocket(canvas.width*0.35, canvas.height*0.5 + shake, 1.3);
            } else {
                drawRocket(canvas.width*0.25, canvas.height*0.6, 1.1);
            }
            requestAnimationFrame(animate);
        }

        function startRound() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            bet = parseInt(document.getElementById('bet-input').value);
            if(isNaN(bet) || bet > balance || bet < 10) {
                tg.showAlert("Check your bet/balance!");
                return;
            }

            balance -= bet;
            document.getElementById('bal-display').innerText = balance;

            // REALISTIC RNG
            let r = Math.random();
            if(r < 0.12) crashAt = 1.00 + Math.random()*0.05;
            else if(r < 0.75) crashAt = 1.1 + Math.pow(Math.random(), 1.5)*2.5;
            else if(r < 0.96) crashAt = 3.5 + Math.random()*8;
            else crashAt = 12 + Math.random()*60;

            isFlying = true; startTime = Date.now();
            document.getElementById('btn-bet').style.display = 'none';
            document.getElementById('btn-cash').style.display = 'block';
            document.getElementById('status-text').innerText = "FLYING...";
            
            playSound(180, 'sawtooth', 0.6, 0.15);
            tg.HapticFeedback.impactOccurred('medium');
        }

        function cashOut() {
            if(!isFlying) return;
            let win = Math.floor(bet * mult);
            balance += win;
            endRound(true, win);
        }

        function endRound(win, amt=0) {
            isFlying = false;
            document.getElementById('bal-display').innerText = balance;
            document.getElementById('modal').style.display = 'flex';
            const val = document.getElementById('modal-val');
            
            if(win) {
                val.innerHTML = `<div class="win">+${amt} ⭐</div><div style="font-size:14px; color:#aaa;">Cashed at x${mult.toFixed(2)}</div>`;
                playSound(550, 'sine', 0.6, 0.2);
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                val.innerHTML = `<div class="lose">CRASHED</div><div style="font-size:14px; color:#aaa;">at x${mult.toFixed(2)}</div>`;
                playSound(80, 'square', 0.4, 0.25);
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('btn-bet').style.display = 'block';
            document.getElementById('btn-cash').style.display = 'none';
            document.getElementById('multiplier').innerText = "1.00x";
            document.getElementById('status-text').innerText = "WAITING FOR BET...";
        }

        function finalizeAndExit() {
            tg.sendData(JSON.stringify({action: "sync_balance", final_balance: balance}));
        }

        animate();
    </script>
</body>
</html>
