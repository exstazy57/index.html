<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DAG Bird Final</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #70c5ce; font-family: sans-serif; touch-action: manipulation; }
        canvas { display: block; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 20; color: white;
        }
        input { padding: 15px; border-radius: 10px; border: none; width: 220px; font-size: 18px; text-align: center; margin-bottom: 10px; }
        button { padding: 15px 30px; background: #f7941d; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="overlay">
    <h1 id="title">DAG BIRD</h1>
    <input type="text" id="nick-input" placeholder="Ваш ник..." maxlength="12">
    <button id="start-btn">ИГРАТЬ</button>
</div>

<canvas id="game"></canvas>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay');
    const nickInput = document.getElementById('nick-input');
    const startBtn = document.getElementById('start-btn');
    const title = document.getElementById('title');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // --- ЗВУКИ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(f, type = 'sine') {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.value = f;
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.1);
    }

    // --- ПАРАМЕТРЫ ИГРЫ ---
    let bird, pipes, score, frame, gameActive = false;
    
    // Проверка ника в памяти
    if (localStorage.getItem('dag_nick')) {
        nickInput.style.display = 'none';
    }

    function reset() {
        bird = { x: 50, y: canvas.height/2, w: 40, h: 30, v: 0, g: 0.5, jump: -8, angle: 0 };
        pipes = [];
        score = 0;
        frame = 0;
    }

    function start() {
        if (nickInput.style.display !== 'none') {
            const n = nickInput.value.trim();
            if (n.length < 2) return alert("Ник слишком короткий!");
            localStorage.setItem('dag_nick', n);
        }
        playSfx(500);
        overlay.style.display = 'none';
        reset();
        gameActive = true;
    }

    startBtn.onclick = start;

    function jump() {
        if (gameActive) {
            bird.v = bird.jump;
            playSfx(400);
        }
    }

    window.onkeydown = (e) => { if (e.code === 'Space') jump(); };
    canvas.ontouchstart = (e) => { e.preventDefault(); jump(); };

    function drawBird() {
        ctx.save();
        ctx.translate(bird.x + bird.w/2, bird.y + bird.h/2);
        bird.angle = Math.min(Math.PI/4, Math.max(-Math.PI/4, bird.v * 0.05));
        ctx.rotate(bird.angle);
        
        // Рисуем птичку (тело)
        ctx.fillStyle = '#f7941d';
        ctx.beginPath();
        ctx.ellipse(0, 0, bird.w/2, bird.h/2, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = 'black'; ctx.lineWidth = 2; ctx.stroke();
        
        // Глаз
        ctx.fillStyle = 'white';
        ctx.beginPath(); ctx.arc(10, -5, 5, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'black';
        ctx.beginPath(); ctx.arc(12, -5, 2, 0, Math.PI*2); ctx.fill();
        
        // Крыло
        ctx.fillStyle = 'orange';
        ctx.beginPath();
        ctx.ellipse(-10, 2, 10, 6, (Math.sin(frame*0.2)), 0, Math.PI*2);
        ctx.fill(); ctx.stroke();
        
        ctx.restore();
    }

    function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Небо
        ctx.fillStyle = '#70c5ce';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (gameActive) {
            bird.v += bird.g;
            bird.y += bird.v;

            if (frame % 100 === 0) {
                let gap = 180;
                let top = Math.random() * (canvas.height - gap - 100) + 50;
                pipes.push({ x: canvas.width, t: top, b: canvas.height - top - gap });
            }

            for (let i = pipes.length - 1; i >= 0; i--) {
                let p = pipes[i];
                p.x -= 3;

                // Рисуем трубы
                ctx.fillStyle = '#2ecc71';
                ctx.fillRect(p.x, 0, 60, p.t);
                ctx.fillRect(p.x, canvas.height - p.b, 60, p.b);
                ctx.strokeStyle = 'black'; ctx.strokeRect(p.x, 0, 60, p.t); ctx.strokeRect(p.x, canvas.height - p.b, 60, p.b);

                // Коллизия
                if (bird.x + bird.w > p.x && bird.x < p.x + 60) {
                    if (bird.y < p.t || bird.y + bird.h > canvas.height - p.b) {
                        die();
                    }
                }

                if (p.x + 60 < 0) { pipes.splice(i, 1); score++; playSfx(800); }
            }

            if (bird.y + bird.h > canvas.height || bird.y < 0) die();
            
            frame++;
        }

        drawBird();

        // Счет
        ctx.fillStyle = 'white';
        ctx.font = 'bold 40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(score, canvas.width/2, 80);

        requestAnimationFrame(loop);
    }

    function die() {
        gameActive = false;
        playSfx(100, 'sawtooth');
        title.innerText = "СЧЕТ: " + score;
        startBtn.innerText = "ЕЩЕ РАЗ";
        overlay.style.display = 'flex';
    }

    loop();
</script>
</body>
</html>
