<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DAG Flappy Bird</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #70c5ce; font-family: sans-serif; }
        canvas { display: block; margin: 0 auto; background: #70c5ce; }
        
        /* –û–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        #reg-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10;
        }
        input { padding: 12px; border-radius: 8px; border: none; width: 200px; font-size: 16px; }
        button { margin-top: 15px; padding: 10px 25px; background: #f7941d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        
        /* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ */
        #leaderboard {
            position: fixed; bottom: -100%; left: 0; width: 100%; height: 50%;
            background: white; border-radius: 20px 20px 0 0; transition: 0.5s; z-index: 5;
            padding: 20px; box-sizing: border-box; box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
        }
        #leaderboard.active { bottom: 0; }
        .score-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div id="reg-screen">
    <h2 style="color: white;">–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º</h2>
    <input type="text" id="nick-input" placeholder="–í–∞—à –Ω–∏–∫...">
    <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
</div>

<div id="leaderboard">
    <div style="display: flex; justify-content: space-between;">
        <h3>üèÜ –õ–∏–¥–µ—Ä—ã</h3>
        <button onclick="closeLeaderboard()" style="background: #ccc; margin: 0;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="leader-list">
        </div>
</div>

<canvas id="game"></canvas>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let bird = { x: 50, y: 150, w: 34, h: 24, gravity: 0.6, lift: -10, velocity: 0 };
    let pipes = [];
    let frame = 0;
    let score = 0;
    let gameRunning = false;

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    function startGame() {
        const nick = document.getElementById('nick-input').value;
        if (nick.length < 2) return alert("–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
        localStorage.setItem('dag_bird_name', nick);
        document.getElementById('reg-screen').style.display = 'none';
        gameRunning = true;
        resetGame();
        loop();
    }

    // –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
    function resetGame() {
        bird.y = 150; bird.velocity = 0; pipes = []; score = 0; frame = 0;
    }

    function loop() {
        if (!gameRunning) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // –ü—Ç–∏—Ü–∞
        bird.velocity += bird.gravity;
        bird.y += bird.velocity;
        ctx.fillStyle = "yellow";
        ctx.fillRect(bird.x, bird.y, bird.w, bird.h);

        // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
        if (frame % 100 === 0) {
            let space = 150;
            let topH = Math.random() * (canvas.height / 2);
            pipes.push({ x: canvas.width, top: topH, bottom: canvas.height - topH - space });
        }

        pipes.forEach((p, i) => {
            p.x -= 3;
            ctx.fillStyle = "green";
            ctx.fillRect(p.x, 0, 50, p.top);
            ctx.fillRect(p.x, canvas.height - p.bottom, 50, p.bottom);

            if (p.x + 50 < 0) { pipes.splice(i, 1); score++; }
            
            // –ö–æ–ª–ª–∏–∑–∏—è
            if (bird.x < p.x + 50 && bird.x + bird.w > p.x && (bird.y < p.top || bird.y + bird.h > canvas.height - p.bottom)) {
                gameOver();
            }
        });

        if (bird.y + bird.h > canvas.height || bird.y < 0) gameOver();

        ctx.fillStyle = "black"; ctx.font = "30px Arial";
        ctx.fillText(score, 20, 50);

        frame++;
        requestAnimationFrame(loop);
    }

    function gameOver() {
        gameRunning = false;
        saveScore(score);
        showLeaderboard();
    }

    window.addEventListener('keydown', (e) => { if (e.code === 'Space') bird.velocity = bird.lift; });
    canvas.addEventListener('touchstart', () => { bird.velocity = bird.lift; });

    // –†–∞–±–æ—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    function saveScore(s) {
        let leaders = JSON.parse(localStorage.getItem('leaders') || "[]");
        const name = localStorage.getItem('dag_bird_name');
        leaders.push({ name, score: s });
        leaders.sort((a, b) => b.score - a.score);
        localStorage.setItem('leaders', JSON.stringify(leaders.slice(0, 5))); // –¢–æ–ø-5
    }

    function showLeaderboard() {
        const list = document.getElementById('leader-list');
        const leaders = JSON.parse(localStorage.getItem('leaders') || "[]");
        list.innerHTML = leaders.map((l, i) => `<div class="score-item"><span>${i+1}. ${l.name}</span><b>${l.score}</b></div>`).join('');
        document.getElementById('leaderboard').classList.add('active');
    }

    function closeLeaderboard() {
        document.getElementById('leaderboard').classList.remove('active');
        gameRunning = true; resetGame(); loop();
    }
</script>
</body>
</html>